@using Goldlight.Blazor.VirtualServer.Components.RequestResponse.Validator
@using System.Collections.ObjectModel
@using System.ComponentModel.Design.Serialization
@inject ProjectProps ProjectProps
@inject NavigationManager NavigationManager
@inject ProjectApi ProjectApi

<MudForm @ref="form" Model="RequestResponse" Validation="@(validator.ValidateValue)" ValidationDelay="0">
  <MudGrid>
    <MudItem xs="12">
      <MudTextField Label="Name" Immediate @bind-Value="RequestResponse.Name" For="@(() => RequestResponse.Name)"/>
      <MudTextField Label="Description" Immediate Lines="3" @bind-Value="RequestResponse.Description" For="@(() => RequestResponse.Description)"/>
    </MudItem>
    <MudItem xs="6">
      <DataContainer HasData="!EditProject">
        <DataTemplate>
          <UploadRequestResponse FileTypes=".json, .request" OnRequestUploaded="OnRequestUploadedAsync" Upload="UploadRequestResponse.UploadType.Request"/>
        </DataTemplate>
      </DataContainer>
      <MudSelect Dense Immediate @bind-Value="RequestResponse.Request.Summary.Method" For="() => RequestResponse.Request.Summary.Method">
        @foreach (string method in httpMethods)
        {
          <MudSelectItem T="string" Value="@method">@method</MudSelectItem>
        }
      </MudSelect>
      <MudTextField Label="Protocol" @bind-Value="RequestResponse.Request.Summary.Protocol" For="@(() => RequestResponse.Request.Summary.Protocol)" />
      <MudNumericField Label="Path" @bind-Value="RequestResponse.Request.Summary.Path" For="@(() => RequestResponse.Request.Summary.Path)" />
      <MudExpansionPanels Dense Class="mt-0" Elevation="0">
        <MudExpansionPanel Dense Class="mt-0 pl=0" Text="Headers" @bind-IsExpanded="requestHeaderExpanded">
          <MudButton OnClick="@(() => AddHeader(RequestResponse.Request.Headers))" Variant="Variant.Filled" Color="Color.Success">Add Header</MudButton>
          <MudDataGrid Dense EditMode="DataGridEditMode.Cell" ReadOnly="false" T="HttpHeader" Items="RequestResponse.Request.Headers" Style="align-items: center;">
            <Columns>
              <PropertyColumn Property="hdr => hdr.Name" />
              <PropertyColumn Property="hdr => hdr.Value"/>
              <TemplateColumn CellClass="d-flex justify-end">
                <EditTemplate>
                  <MudTooltip Text="Delete this header">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"OnClick="@(() => DeleteHeader(RequestResponse.Request.Headers, context.Item))"/>
                  </MudTooltip>
                </EditTemplate>
              </TemplateColumn>
            </Columns>
          </MudDataGrid>
        </MudExpansionPanel>
      </MudExpansionPanels>
      <MudTextField Label="Content" Immediate @bind-Value="RequestResponse.Request.Content" For="@(() => RequestResponse.Request.Content)" Lines="20"/>
    </MudItem>
    <MudItem xs="6">
      <DataContainer HasData="!EditProject">
        <DataTemplate>
          <UploadRequestResponse FileTypes=".json, .response" ButtonText="Upload Response" OnResponseUploaded="OnResponseUploadedAsync" Upload="UploadRequestResponse.UploadType.Response"/>
        </DataTemplate>
      </DataContainer>
      <MudTextField Label="Protocol" Immediate @bind-Value="RequestResponse.Response.Summary.Protocol" For="@(() => RequestResponse.Response.Summary.Protocol)"/>
       <MudNumericField Label="Status" Immediate @bind-Value="RequestResponse.Response.Summary.Status" For="@(() => RequestResponse.Response.Summary.Status)" />
      <MudExpansionPanels Dense Class="mt-0" Elevation="0">
        <MudExpansionPanel Dense Class="mt-0 pl=0" DisableGutters Text="Headers" @bind-IsExpanded="responseHeaderExpanded">
          <MudButton OnClick="@(() => AddHeader(RequestResponse.Response.Headers))" Variant="Variant.Filled" Color="Color.Success">Add Header</MudButton>
          <MudDataGrid Dense EditMode="DataGridEditMode.Cell" ReadOnly="false" T="HttpHeader" Items="RequestResponse.Response.Headers" Style="align-items: center;">
            <Columns>
              <PropertyColumn Property="hdr => hdr.Name"/>
              <PropertyColumn Property="hdr => hdr.Value"/>
              <TemplateColumn CellClass="d-flex justify-end">
                <EditTemplate>
                  <MudTooltip Text="Delete this header">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteHeader(RequestResponse.Response.Headers, context.Item))"/>
                  </MudTooltip>
                </EditTemplate>
              </TemplateColumn>
            </Columns>
          </MudDataGrid>
        </MudExpansionPanel>
      </MudExpansionPanels>
      <MudTextField Label="Content" Immediate @bind-Value="RequestResponse.Response.Content" For="@(() => RequestResponse.Response.Content)" Lines="20"/>
    </MudItem>
  </MudGrid>
  <MudButton Disabled="submitted" OnClick="(async () => await OnSubmitAsync())" StartIcon="@Icons.Material.Filled.Save" Variant="Variant.Filled" Color="Color.Primary" Class="mt-2">Save</MudButton>
</MudForm>

 @code {

   [Parameter]
   public bool EditProject { get; set; }

   public RequestResponsePair RequestResponse { get; set; } = new();
   private bool requestHeaderExpanded = true;
   private bool responseHeaderExpanded = true;
   private Project? project;
   private bool submitted;
   private MudForm form = null!;
   private RequestResponsePairValidator validator = new();

   private readonly string[] httpMethods =
   {
     "POST",
     "GET",
     "PUT",
     "PATCH",
     "DELETE",
     "OPTIONS",
     "ANY"
   };

   protected override void OnInitialized()
   {
     if (ProjectProps.SelectedProject is null)
     {
       NavigationManager.NavigateTo("/");
     }
     project = ProjectProps.SelectedProject!;
     project.RequestResponses ??= new List<RequestResponsePair>();
     if (!EditProject)
     {
       project.RequestResponses.Add(RequestResponse);
     }
     else
     {
       RequestResponse = ProjectProps.SelectedRequestResponse!;
     }
   }

   private void DeleteHeader(ObservableCollection<HttpHeader> headers, HttpHeader header)
   {
     headers.Remove(header);
   }

   private void AddHeader(ObservableCollection<HttpHeader> headers)
   {
     headers.Add(new HttpHeader());
   }

   private async Task OnSubmitAsync()
   {
     submitted = true;
     await form.Validate();
     if (form.IsValid)
     {
       await ProjectApi.UpdateProject(project!);
       ProjectProps.Clear();
       NavigationManager.NavigateTo("/");
     }
     submitted = false;
   }

   private async Task OnResponseUploadedAsync(Response response)
   {
     RequestResponse.Response = response;
     StateHasChanged();
     await form.Validate();
   }

   private async Task OnRequestUploadedAsync(Request request)
   {
     RequestResponse.Request = request;
     StateHasChanged();
     await form.Validate();
   }
}
